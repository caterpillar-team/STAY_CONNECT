<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout}">
<head>
    <!-- PortOne -->
    <script th:src="@{/lib/portone/iamport.js}"></script>
    <!-- axios -->
    <script th:src="@{/lib/axios/axios.min.js}"></script>

    <script th:inline="javascript">
        const buyerTel = /*[[${phoneNumber}]]*/;
        const userId = /*[[${userId}]]*/;
        const roomInfoId = /*[[${roomInfoId}]]*/;
    </script>

    <script>
        // 결제
        document.addEventListener('DOMContentLoaded', function () {
            IMP.init('imp66857630');

            var merchantUid = new Date().getTime();

            const payBtn = document.getElementById('confirm_btn');
            payBtn.addEventListener('click', function () {
                console.log('test');

                IMP.request_pay(
                    {
                        pg: 'html5_inicis',
                        pay_method: 'card',
                        merchant_uid: merchantUid,
                        name: '테스트 결제',
                        amount: 100,
                        buyer_tel: buyerTel,
                    },
                    function (resp) {
                        console.log(resp)

                        if (resp.success) {
                            const paymentData = {
                                imp_uid: resp.imp_uid,
                                merchant_uid: resp.merchant_uid,
                                paid_amount: resp.paid_amount,
                                pay_method: resp.pay_method,
                                userId: userId,
                                roomInfoId: roomInfoId
                            };
                            const formData = new FormData();
                            formData.append('imp_uid',resp.imp_uid);
                            formData.append('merchant_uid', resp.merchant_uid);
                            formData.append('paid_amount', resp.paid_amount);
                            formData.append('pay_method', resp.pay_method);
                            formData.append('userId', userId);
                            formData.append('roomInfoId', roomInfoId);

                            axios.post('/user/paySuccess', formData, {headers: {'Content-Type': 'x-www-form-urlencoded'}})
                                .then(response => {
                                    console.log('Reservation created:', response.data);

                                    var modal = document.getElementById('reservationModal');
                                    var modalBackdrop = document.getElementsByClassName('modal-backdrop')[0];
                                    modal.style.display = 'none';
                                    if (modalBackdrop) {
                                        modalBackdrop.parentNode.removeChild(modalBackdrop);
                                    }
                                    document.body.classList.remove('modal-open');
                                    document.body.style = "";

                                    window.location.href = '/user/myPage';
                                })
                                .catch(error => {
                                    console.error('Error creating reservation:', error);
                                    alert("예약 생성 중 오류가 발생했습니다. 다시 시도해주세요.");
                                });
                        } else {
                            alert("결제에 실패했습니다.");
                            console.error('Payment failed:', resp);
                        }
                    }
                );
            });
        });
    </script>

    <meta charset="UTF-8"/>
    <th:block layout:fragment="title">
        <title>Accommodation Detail</title>
    </th:block>

    <!-- bootstrap -->
    <th:block layout:fragment="script">
    </th:block>
    <th:block layout:fragment="css">
        <link rel="stylesheet" th:href="@{/css/pages/accom_detail.css}"/>
    </th:block>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</head>

<body>
<th:block layout:fragment="leftAside">
    <section th:replace="~{fragments/user/userChat_frag::userChat}"></section>
</th:block>
<!-- 날짜검색 fragment 삽입 -->

<!-- fragment main -->
<th:block layout:fragment="main">
    <section class="accomImg">
        <div class="accomImg1">
            <img alt="" th:src="@{/img/StayConnect-main.jpg}"/>
        </div>
        <div class="carousel slide" id="carouselExampleIndicators">
            <div class="carousel-indicators">
                <button
                        type="button"
                        data-bs-target="#carouselExampleIndicators"
                        data-bs-slide-to="0"
                        class="active"
                        aria-current="true"
                        aria-label="Slide 1"
                ></button>
                <button
                        type="button"
                        data-bs-target="#carouselExampleIndicators"
                        data-bs-slide-to="1"
                        aria-label="Slide 2"
                ></button>
                <button
                        type="button"
                        data-bs-target="#carouselExampleIndicators"
                        data-bs-slide-to="2"
                        aria-label="Slide 3"
                ></button>
            </div>
            <div class="carousel-inner">
                <div class="carousel-item active">
                    <img
                            alt="..."
                            class="d-block w-100"
                            th:src="@{/img/StayConnect-main.jpg}"
                    />
                </div>
                <div class="carousel-item">
                    <img
                            alt="..."
                            class="d-block w-100"
                            th:src="@{/img/StayConnect_main2.jpg}"
                    />
                </div>
                <div class="carousel-item">
                    <img
                            alt="..."
                            class="d-block w-100"
                            th:src="@{/img/StayConnect_main3.jpg}"
                    />
                </div>
            </div>
            <button
                    class="carousel-control-prev"
                    data-bs-slide="prev"
                    data-bs-target="#carouselExampleIndicators"
                    type="button"
            >
                <span aria-hidden="true" class="carousel-control-prev-icon"></span>
                <span class="visually-hidden">Previous</span>
            </button>
            <button
                    class="carousel-control-next"
                    data-bs-slide="next"
                    data-bs-target="#carouselExampleIndicators"
                    type="button"
            >
                <span aria-hidden="true" class="carousel-control-next-icon"></span>
                <span class="visually-hidden">Next</span>
            </button>
        </div>
    </section>
    <section class="accomMain">
        <div>
            <div
                    class="category_name"
                    th:text="${accom.accommodation.category.name}"
            >
                호텔/펜션
            </div>
            <div class="accomName" th:text="${accom.accommodation.name}">
                숙소이름
            </div>
        </div>
        <div class="">
            <div class="star_rating">
                ★★★★★
                <!--                <a th:if="${reviewDto.getAverageRating() != 0}" class="on"  th:each="num : ${#numbers.sequence(0, review.getAverageRating()-1)}">★</a>-->
                <!--                <a th:unless="${reviewDto.getAverageRating() != 0}">★★★★★</a>-->
            </div>
            <div class="">평가인원</div>
            <a th:href="@{#}">리뷰보기</a>
        </div>
        <div class="reviewBox">
            <div class="reviewSlider">
                <div th:each="review : ${reviews}">
                    <div class="review">
                        <div class="content" th:text="${review.contents}">리뷰</div>
                        <div class="reviewWriter">
                            <div class="user" th:text="${review.user.username}">
                                닉네임
                            </div>
                            <div
                                    class="createdAt"
                                    th:text="${#dates.format(review.createdAt, 'yyyy-MM-dd HH:mm')}"
                            >
                                시기
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <hr/>
    <section class="accomDetail">
        <!--    반복문 수정중    -->
        <div class="accomDetailContainer">
            <div class="accomType">
                <img alt="" th:src="@{/img/StayConnect-main.jpg}"/>
                <!--객실타입사진-->
                <div class="detail">
                    <div class="roomType" th:text="${accom.roomType}">
                        객실타입이름
                    </div>
                    <div class="numberOfPeople">
                        <span class="material-symbols-outlined">person</span>
                        <span
                                class="standard"
                                th:text="${'기준인원 '+accom.numberOfPeopleStandard+'인 / '}"
                        >기준인원</span
                        >
                        <span
                                class="max"
                                th:text="${'최대인원 '+accom.numberOfPeopleMax+'인'}"
                        >최대인원</span
                        >
                    </div>
                    <div class="bedType">
                        <span class="material-symbols-outlined">bed</span>
                        <span class="bedType" th:text="${accom.bedType}">침대타입</span>
                    </div>
                </div>
            </div>
            <div class="detail">
                <div class="" th:text="${accom.stayType}">숙박/대실</div>
                <div class="">
                    <span th:text="${'체크인 : '+accom.checkInTime}">체크인시간</span>
                    <span>/</span>
                    <span th:text="${'체크아웃 : '+accom.checkOutTime}"
                    >체크아웃시간</span
                    >
                </div>
                <div class="price" th:text="${accom.price+'원'}">가격</div>
                <div class="cancellationPolicy">취소정책</div>
                <div>
                    <a class="pay_btn btn btn-primary" data-toggle="modal" data-target="#reservationModal">예약하기</a>
                </div>
            </div>

            <!-- 모달 -->
            <div class="modal fade" id="reservationModal" tabindex="-1" aria-labelledby="reservationModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="reservationModalLabel">예약확인</h5>
                        </div>
                        <div class="modal-body">
                            <!-- 모달 내용 -->
                            <div class="roomType" th:text="${accom.roomType}" style="font-weight:bold; font-size:1.2rem;">
                                객실타입이름
                            </div>
                            </br>

                            <div class="people">
                                <span class="material-symbols-outlined">person</span>
                                <span
                                        class="standard"
                                        th:text="${'인원 '+accom.numberOfPeopleStandard+'인'}"
                                >인원</span>
                            </div>

                            <div class="bedType">
                                <span class="material-symbols-outlined">bed</span>
                                <span class="bedType" th:text="${accom.bedType}">침대타입</span>
                            </div>
                            </br>

                            <div class="" th:text="${accom.stayType}" style="font-weight:bold; font-size:1.2rem;"></div>
                            </hr>

                            <div class="">
                                <span th:text="${'체크인 : '+accom.checkInTime}">체크인시간</span>
                                <span>/</span>
                                <span th:text="${'체크아웃 : '+accom.checkOutTime}"
                                >체크아웃시간</span
                                >
                            </div>
                            </hr>
                            </br>

                            <div class="price" th:text="${accom.price+'원'}">가격</div>
                            </br>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">닫기</button>
                            <button id="confirm_btn" type="button" class="btn btn-primary">결제하기</button>
                        </div>
                    </div>
                </div>
            </div>
        <hr/>
        <div class="accomDetailContainer">
            <div class="accomType">
                <img alt="" th:src="@{/img/StayConnect-main.jpg}"/>
                <!--객실타입사진-->
                <div class="detail">
                    <div class="roomType" th:text="${accom.roomType}">
                        객실타입이름
                    </div>
                    <div class="numberOfPeople">
                        <span class="material-symbols-outlined">person</span>
                        <span
                                class="standard"
                                th:text="${'기준인원 '+accom.numberOfPeopleStandard+'인 / '}"
                        >기준인원</span
                        >
                        <span
                                class="max"
                                th:text="${'최대인원 '+accom.numberOfPeopleMax+'인'}"
                        >최대인원</span
                        >
                    </div>
                    <div class="bedType">
                        <span class="material-symbols-outlined">bed</span>
                        <span class="bedType" th:text="${accom.bedType}">침대타입</span>
                    </div>
                </div>
            </div>
            <div class="detail">
                <div class="" th:text="${accom.stayType}">숙박/대실</div>
                <div class="">
                    <span th:text="${'체크인 : '+accom.checkInTime}">체크인시간</span>
                    <span>/</span>
                    <span th:text="${'체크아웃 : '+accom.checkOutTime}"
                    >체크아웃시간</span
                    >
                </div>
                <div class="price" th:text="${accom.price+'원'}">가격</div>
                <div class="cancellationPolicy">취소정책</div>
                <div>
                    <a th:href="@{#}">예약하기</a>
                </div>
            </div>
        </div>
        <hr/>
        <div class="accomDetailContainer">
            <div class="accomType">
                <img alt="" th:src="@{/img/StayConnect-main.jpg}"/>
                <!--객실타입사진-->
                <div class="detail">
                    <div class="roomType" th:text="${accom.roomType}">
                        객실타입이름
                    </div>
                    <div class="numberOfPeople">
                        <span class="material-symbols-outlined">person</span>
                        <span
                                class="standard"
                                th:text="${'기준인원 '+accom.numberOfPeopleStandard+'인 / '}"
                        >기준인원</span
                        >
                        <span
                                class="max"
                                th:text="${'최대인원 '+accom.numberOfPeopleMax+'인'}"
                        >최대인원</span
                        >
                    </div>
                    <div class="bedType">
                        <span class="material-symbols-outlined">bed</span>
                        <span class="bedType" th:text="${accom.bedType}">침대타입</span>
                    </div>
                </div>
            </div>
            <div class="detail">
                <div class="" th:text="${accom.stayType}">숙박/대실</div>
                <div class="">
                    <span th:text="${'체크인 : '+accom.checkInTime}">체크인시간</span>
                    <span>/</span>
                    <span th:text="${'체크아웃 : '+accom.checkOutTime}"
                    >체크아웃시간</span
                    >
                </div>
                <div class="price" th:text="${accom.price+'원'}">가격</div>
                <div class="cancellationPolicy">취소정책</div>
                <div>
                    <a th:href="@{#}">예약하기</a>
                </div>
            </div>
        </div>
        <hr/>
    </section>
    <section class="reviewList" th:each="review : ${reviews}">
        <!-- 후기 목록 -->
        <div id="revivewContainer">
            <div class="reviewWriter">
                <img alt="" th:src="@{/img/StayConnect-main.jpg}"/>
                <!--유저프로필사진-->
                <span class="user" th:text="${review.user.username}">닉네임</span>
            </div>
            <form method="POST" th:action="@{/accom_detail}">
                <input
                        type="hidden"
                        id="reviewId"
                        name="reviewId"
                        th:value="${review.id}"
                />
                <div>
                    <input
                            type="button"
                            class="btn p-0 btn-md"
                            name="reviewUser"
                            th:value="${review.user.getUsername()}"
                    />
                    <small
                            th:text="${#strings.substring(review.createdAt,0,19)}"
                    ></small>
                </div>
                <div th:text="${review.contents}"></div>
                <!-- 수정중 -->
                <div
                        class="text-right"
                        th:if="${review.user==review.user}"
                        style="display: none"
                >
              <span
              ><button type="submit" name="submit" value="update">
                  수정
                </button></span
              >
                    <span
                    ><button type="submit" name="submit" value="delete">
                  삭제
                </button></span
                    >
                </div>
            </form>
        </div>
    </section>
</th:block>
</body>
</html>
